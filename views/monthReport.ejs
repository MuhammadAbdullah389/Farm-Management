<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Report</title>
    <link rel="stylesheet" href="/styles/monthlyrep.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <header>
        <h2>Monthly Report for <%= username %>!</h2>
        <h4><%= date %></h4>
    </header>

    <nav>
        <ul>
            <% if (role === "admin") { %>
                <li><a href="/">Dashboard</a></li>
                <li><a href="/update">Update a Record</a></li>
            <% } %>
            <li><a href="/view">View Records</a></li>
            <li><a href="/contact">Contact the Developer</a></li>
        </ul>
    </nav>

    <h2>Monthly Entry Report</h2>

    <h3>Month: <%= month %>/<%= year %></h3>

    <table id="dailyReportTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Total Milk (liters)</th>
                <th>Revenue by Milk (PKR)</th>
                <th>Other Revenue (PKR)</th>
                <th>Total Revenue (PKR)</th>
                <th>Total Expenses (PKR)</th>
                <th>Net Balance (PKR)</th>
            </tr>
        </thead>
        <tbody>
            <% let totalMilkForMonth = 0; %>
            <% let totalRevenueFromMilk = 0; %>
            <% let totalOtherRevenue = 0; %>
            <% let totalRevenue = 0; %>
            <% let totalExpenses = 0; %>
            <% let netBalance = 0; %>

            <% records.forEach(record => { %>
                <% 
                    let totalMilk = record.morningMilkQuantity + record.eveningMilkQuantity;
                    let milkRevenue = totalMilk * 140; 
                    let otherRev = record.totalRevenue - milkRevenue;
                %>
                <tr>
                    <td><%= record.date %></td>
                    <td><%= totalMilk %> liters</td>
                    <td><%= milkRevenue %> PKR</td>
                    <td><%= otherRev %> PKR</td>
                    <td><%= record.totalRevenue %> PKR</td>
                    <td><%= record.totalExpenditure %> PKR</td>
                    <td><%= record.Balance %> PKR</td>
                </tr>

                <% 
                    // Accumulate totals for the month
                    totalMilkForMonth += totalMilk;
                    totalRevenueFromMilk += milkRevenue;
                    totalOtherRevenue += otherRev;
                    totalRevenue += record.totalRevenue;
                    totalExpenses += record.totalExpenditure;
                    netBalance += record.Balance;
                %>
            <% }) %>
        </tbody>
    </table>

    <h4>Aggregated Values for the Month</h4>
    <table id="aggregatedValues">
        <tbody>
            <tr>
                <td>Total Milk for the Month</td>
                <td><%= totalMilkForMonth %> liters</td>
            </tr>
            <tr>
                <td>Total Revenue from Milk</td>
                <td><%= totalRevenueFromMilk %> PKR</td>
            </tr>
            <tr>
                <td>Total Other Revenue</td>
                <td><%= totalOtherRevenue %> PKR</td>
            </tr>
            <tr>
                <td>Total Revenue</td>
                <td><%= totalRevenue %> PKR</td>
            </tr>
            <tr>
                <td>Total Expenses</td>
                <td><%= totalExpenses %> PKR</td>
            </tr>
        </tbody>
    </table>

    <h4>Monthly Report Summary</h4>
    <table id="summaryTable">
        <tbody>
            <tr>
                <td>Opening Balance</td>
                <td><%= monthlyRep.openingBalance %> PKR</td>
            </tr>
            <tr>
                <td>Net Balance</td>
                <td><%= monthlyRep.netBalance %> PKR</td>
            </tr>
            <tr>
                <td>Closing Balance</td>
                <td><%= monthlyRep.closingBalance %> PKR</td>
            </tr>
        </tbody>
    </table>
    <button id="downloadBtn">Download PDF</button>

    <script>
    document.getElementById('downloadBtn').addEventListener('click', function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4'); // Portrait orientation, A4 size

        // Set initial vertical position for the content
        let yPosition = 20;

        // Helper function to add body text (headers, paragraphs, etc.) to PDF
        const addTextToPDF = (text, yPosition) => {
            doc.text(text, 10, yPosition); // Add the text at specified position
            return yPosition + 10; // Return the new yPosition (with some space below)
        };

        // Add the main headers and text (for body content)
        yPosition = addTextToPDF('Monthly Report for <%= username %>', yPosition);
        yPosition = addTextToPDF('Month: <%= month %>/<%= year %>', yPosition);

        // Helper function to add table to PDF
        const addTableToPDF = (table, yPosition) => {
            doc.autoTable({
                html: table,
                startY: yPosition,  // Start the table below the last content
                margin: { top: 10, left: 10, right: 10 }, // Add margins around the table
                theme: 'grid', // Grid theme for table styling
                styles: {
                    fontSize: 12, // Set font size
                    cellPadding: 5, // Padding in cells
                },
                bodyStyles: {
                    overflow: 'linebreak', // Ensure content in cells breaks properly
                    minCellHeight: 20, // Minimum height for cells to avoid too small rows
                },
                pageBreak: 'auto', // Allow table rows to break across pages
                rowPageBreak: 'auto', // Ensure rows break correctly across pages
            });

            // Return the new yPosition after the table is added
            return doc.lastAutoTable.finalY + 10; // Space between tables
        };

        // Add the first table (Main Report Table) and update yPosition
        const firstTable = document.querySelector("#dailyReportTable"); // Select the first table
        yPosition = addTableToPDF(firstTable, yPosition);

        // Add the second table (Aggregated Values) and update yPosition
        const secondTable = document.querySelector("#aggregatedValues"); // Select the second table
        yPosition = addTableToPDF(secondTable, yPosition);

        // Add the third table (Summary Table) and update yPosition
        const thirdTable = document.querySelector("#summaryTable"); // Select the third table
        yPosition = addTableToPDF(thirdTable, yPosition);

        // Once all tables and content are added, save the PDF with a custom name
        doc.save('monthly_report.pdf');
    });
</script>

</body>
</html>
